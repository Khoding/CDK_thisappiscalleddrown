{% load static widget_tweaks extras %}

<div class="container gradient-l2 text-white small-padding-container rounded pb-2">
    <div class="row m-0 book-table">
        {% block activity_list %}
            {{ upcoming_activities|length }} Activité{{ upcoming_activities|pluralize:"s" }}
            {% for activity in upcoming_activities %}
                <div class="card mb-2 bg-wt rounded" data-activity-id="{{ activity.id }}">
                    <div class="card-header px-0 bg-transparent">
                        <h4 class="d-flex mb-0">
                            <span class="col">
                                <strong>{% if activity.end_date %}Du {% endif %} {{ activity.start_date }}
                                    {% if activity.end_date %} au {{ activity.end_date }} {% endif %}</strong>
                            </span>

                            <span class="col-auto" style="z-index: 50;">
                                {% if user in activity.participants.all or user == activity.creator %}
                                    {% for inscription in activity.inscriptions.all %}
                                        {% if user == inscription.user %}
                                            {% comment %} {% if inscription.presence %}
                                                <button class="btn btn-success form-control" onClick="updateInscription({{inscription.id}}, {{ activity.pk }}, '{{inscription.presence}}', {{inscription.guests_number}}, '{{inscription.remarks}}')" data-bs-toggle="modal" data-bs-target="#inscriptionUpdateModal">Inscrit</button>
                                            {% else %}
                                                <button class="btn btn-danger form-control" onClick="updateInscription({{inscription.id}}, {{ activity.pk }}, '{{inscription.presence}}', {{inscription.guests_number}}, '{{inscription.remarks}}')" data-bs-toggle="modal" data-bs-target="#inscriptionUpdateModal">Excusé</button>
                                            {% endif %} {% endcomment %}
                                            <button type="button"
                                                class="btn btn-warning btn-sm js-update-book"
                                                data-url="{% url 'koolapic:update_inscription_ajax' inscription.slug %}">
                                                <span class="glyphicon glyphicon-pencil"></span> Edit
                                            </button>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inscriptionModal" data-bs-activity="{{ activity.pk }}">
                                        Répondre
                                    </button>
                                {% endif %}
                            </span>
                        </h4>
                    </div>
                    <div class="card-body px-0 pb-2 pt-0">
                        <h5 class="text-ellipsis">
                            Emplacement: <strong>{{ activity.start_location }} {% if activity.end_location %} →
                            {{ activity.end_location }} {% endif %}</strong>
                        </h5>
                        <div class="text-ellipsis">
                            Nom de l'activité: <strong>{{ activity.name }}</strong>
                        </div>
                        <div class="text-ellipsis">
                            Dans groupe: <strong>{{ activity.group }}</strong>
                        </div>
                        <div class="text-ellipsis{% if user == activity.creator %} text-primary{% endif %}">
                            Organisateur: <strong>{{ activity.creator }}</strong>
                        </div>
                    </div>
                    <a href="{% url 'koolapic:activity_detail' slug=activity.slug %}" class="stretched-link"></a>
                </div>
            {% empty %}
                <div class="empty">Vous n'avez pas d'activités à venir</div>
            {% endfor %}

            <div class="modal" id="modal-book">
                <div class="modal-dialog">
                    <div class="modal-content">

                    </div>
                </div>
            </div>

            {% comment %} <div class="modal text-black" id="inscriptionUpdateModal" tabindex="-1" aria-labelledby="inscriptionUpdateModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="inscriptionUpdateModal">Modifier l'inscription</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="updateInscription" enctype="multipart/form-data" action="{% url 'koolapic:update_inscription_ajax' %}" method="POST" novalidate>
                                {% csrf_token %}

                                <div class="non-field-errors">
                                    {{ form.non_field_errors }}
                                </div>

                                <div class="hidden-fields-errors">
                                    {% for hidden_field in form.hidden_fields %}
                                        {{ hidden_field.errors }}
                                        {{ hidden_field }}
                                    {% endfor %}
                                </div>

                                <div class="text-danger">
                                    {{ form.non_field_errors }}
                                </div>

                                <div class="row mb-2">
                                    <div class="col select_activity_inscription">
                                        <div class="input-group">
                                            <div class="form-floating">
                                                {{ form.activity|add_class:"form-select activity"|attr:"placeholder:Activity" }}
                                                {{ form.activity.label_tag }}
                                            </div>
                                        </div>
                                        {% if form.activity.help_text %}
                                            <span class="text-small text-muted">{{ form.activity.help_text }}</span>
                                        {% endif %}
                                        {% for error in form.activity.errors %}
                                            <small class="form-text text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>

                                    <div class="col-auto">
                                        <div class="form-check ps-0">
                                            {{ form.presence.label_tag }}
                                            {{ form.presence|add_class:"d-inline-block presence" }}
                                        </div>
                                        {% if form.presence.help_text %}
                                            <span class="text-small text-muted">{{ form.presence.help_text }}</span>
                                        {% endif %}
                                        {% for error in form.presence.errors %}
                                            <small class="form-text text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>

                                    <div class="col">
                                        <div class="form-floating">
                                            {{ form.guests_number|add_class:"form-control participants"|attr:"placeholder:Activity name" }}
                                            {{ form.guests_number.label_tag }}
                                        </div>
                                        {% if form.guests_number.help_text %}
                                            <span class="text-small text-muted">{{ form.guests_number.help_text }}</span>
                                        {% endif %}
                                        {% for error in form.guests_number.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-floating">
                                            {{ form.remarks|add_class:"form-control remarks"|attr:"placeholder:Activity remarks" }}
                                            {{ form.remarks.label_tag }}
                                        </div>
                                        {% if form.remarks.help_text %}
                                            <span class="text-small text-muted">{{ form.remarks.help_text }}</span>
                                        {% endif %}
                                        {% for error in form.remarks.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary col-auto mt-2">Modifier</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div> {% endcomment %}

            <div class="modal text-black" id="inscriptionModal" tabindex="-1" aria-labelledby="inscriptionModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="inscriptionModalLabel">Répondre</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form enctype="multipart/form-data" method="POST" novalidate>
                                {% csrf_token %}

                                <div class="non-field-errors">
                                    {{ form.non_field_errors }}
                                </div>

                                <div class="hidden-fields-errors">
                                    {% for hidden_field in form.hidden_fields %}
                                        {{ hidden_field.errors }}
                                        {{ hidden_field }}
                                    {% endfor %}
                                </div>

                                <div class="text-danger">
                                    {{ form.non_field_errors }}
                                </div>

                                <div class="row mb-2">
                                    <div class="col select_activity_inscription">
                                        <div class="input-group">
                                            <div class="form-floating">
                                                {{ form.activity|add_class:"form-select"|attr:"placeholder:Activity" }}
                                                {{ form.activity.label_tag }}
                                            </div>
                                        </div>
                                        {% if form.activity.help_text %}
                                            <span class="text-small text-muted">{{ form.activity.help_text }}</span>
                                        {% endif %}
                                        {% for error in form.activity.errors %}
                                            <small class="form-text text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>

                                    <div class="col-auto">
                                        <div class="form-check ps-0">
                                            {{ form.presence.label_tag }}
                                            {{ form.presence|add_class:"d-inline-block" }}
                                        </div>
                                        {% if form.presence.help_text %}
                                            <span class="text-small text-muted">{{ form.presence.help_text }}</span>
                                        {% endif %}
                                        {% for error in form.presence.errors %}
                                            <small class="form-text text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>

                                    <div class="col">
                                        <div class="form-floating">
                                            {{ form.guests_number|add_class:"form-control"|attr:"placeholder:Activity name" }}
                                            {{ form.guests_number.label_tag }}
                                        </div>
                                        {% if form.guests_number.help_text %}
                                            <span class="text-small text-muted">{{ form.guests_number.help_text }}</span>
                                        {% endif %}
                                        {% for error in form.guests_number.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-floating">
                                            {{ form.remarks|add_class:"form-control"|attr:"placeholder:Activity remarks" }}
                                            {{ form.remarks.label_tag }}
                                        </div>
                                        {% if form.remarks.help_text %}
                                            <span class="text-small text-muted">{{ form.remarks.help_text }}</span>
                                        {% endif %}
                                        {% for error in form.remarks.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary col-auto mt-2">Répondre</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                var inscriptionModal = document.getElementById('inscriptionModal')
                inscriptionModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget

                    var activity = button.getAttribute('data-bs-activity')

                    var modalActivity = inscriptionModal.querySelector('#id_activity')
                    var modalAccompagnants = inscriptionModal.querySelector('#id_guests_number')
                    var modalRemarks = inscriptionModal.querySelector('#id_remarks')

                    modalActivity.value = activity
                    modalAccompagnants.value = 0
                    modalRemarks.value = ""
                });
            </script>

            {% comment %}
                <script>
                    function updateInscription(id, activity, presence, guests_number, remarks) {
                        if (id) {
                            presence.toString() === 'True' ? presence = true : presence = false
                            remarks === 'None' ? remarks = "" : remarks = remarks

                            $('#id_activity').val(activity);
                            $('#id_presence').prop('checked', presence);
                            $('#id_guests_number').val(guests_number);
                            $('#id_remarks').val(remarks);
                        }
                    }

                    $('#updateInscription').on('submit', function(event){
                        event.preventDefault();
                        console.log("form submitted!")  // sanity check
                        create_post();
                    });

                    function create_post() {
                        console.log("create post is working!") // sanity check
                        console.log($('#id_activity').val())
                        console.log($('#id_presence').val())
                        console.log($('#id_guests_number').val())
                        console.log($('#id_remarks').val())
                        // TODO C'EST ICI J'ai pas ajax
                        $.ajax({
                            url : "{% url 'koolapic:update_inscription_ajax' slug= %}", // the endpoint
                            type : "POST", // http method
                            data : { the_post : $('#id_activity').val(), presence : $('#id_presence').val(), guests_number : $('#id_guests_number').val(), remarks : $('#id_remarks').val() }, // data sent with the post request

                            // handle a successful response
                            success : function(json) {
                                $('#post-text').val(''); // remove the value from the input
                                console.log(json); // log the returned json to the console
                                console.log("success"); // another sanity check
                            },

                            // handle a non-successful response
                            error : function(xhr,errmsg,err) {
                                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                            }
                        });
                    };
                </script>
            {% endcomment %}

            <script>
                 $(function () {
                    /* Functions */

                    var loadForm = function () {
                        var btn = $(this);
                        $.ajax({
                            url: btn.attr("data-url"),
                            type: 'get',
                            dataType: 'json',
                            beforeSend: function () {
                                $("#modal-book .modal-content").html("");
                                $("#modal-book").modal("show");
                            },
                            success: function (data) {
                                $("#modal-book .modal-content").html(data.html_form);
                            }
                        });
                    };

                    var saveForm = function () {
                        var form = $(this);
                        $.ajax({
                            url: form.attr("action"),
                            data: form.serialize(),
                            type: form.attr("method"),
                            dataType: 'json',
                            success: function (data) {
                                if (data.form_is_valid) {
                                    $("#book-table tbody").html(data.html_book_list);
                                    $("#modal-book").modal("hide");
                                }
                                else {
                                    $("#modal-book .modal-content").html(data.html_form);
                                }
                            }
                        });
                        return false;
                    };

                    /* Binding */

                    // Update book
                    $("#book-table").on("click", ".js-update-book", loadForm);
                    $("#modal-book").on("submit", ".js-book-update-form", saveForm);
                });
            </script>

        {% endblock activity_list %}
    </div>
</div>
